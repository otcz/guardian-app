<div class="orgcfg-wrapper">
  <div class="page-header">
    <div class="titles">
      <h2>Gestionar Organización</h2>
      <p class="subtitle" *ngIf="org">
        {{ org.nombre }}
        <span class="chip" [class.chip-success]="org.activa" [class.chip-danger]="!org.activa">{{ org.activa ? 'ACTIVA' : 'INACTIVA' }}</span>
      </p>
    </div>
    <span class="spacer"></span>
    <button pButton type="button" icon="pi pi-arrow-left" label="Volver" class="p-button-text" (click)="back()"></button>
  </div>

  <p-message *ngIf="error" severity="error" [text]="error"></p-message>
  <p-message *ngIf="success" severity="success" [text]="success"></p-message>

  <div class="grid">
    <p-card class="card strategy-card">
      <div class="card-header"><h3>Estrategia de Gobernanza</h3></div>

      <!-- Estrategia vigente (única) -->
      <div class="field">
        <label for="estrategiaVigente">Estrategia vigente</label>
        <p-dropdown id="estrategiaVigente"
                    [options]="strategies"
                    optionLabel="nombre"
                    optionValue="id"
                    [(ngModel)]="selectedStrategyId"
                    (onChange)="onStrategyChange()"
                    [filter]="true"
                    filterBy="nombre,descripcion"
                    [showClear]="true"
                    filterPlaceholder="Buscar estrategia..."
                    placeholder="Seleccione una estrategia">
          <ng-template pTemplate="selectedItem" let-s>
            <div class="opt-label" *ngIf="s as ss">
              <span class="opt-title">{{ ss.nombre }}</span>
              <span class="opt-sep" *ngIf="ss.descripcion"> - </span>
              <span class="opt-desc" *ngIf="ss.descripcion">{{ ss.descripcion }}</span>
            </div>
          </ng-template>
          <ng-template pTemplate="item" let-s>
            <div class="opt-item">
              <span class="opt-title">{{ s.nombre }}</span>
              <span class="opt-sep" *ngIf="s.descripcion"> - </span>
              <span class="opt-desc" *ngIf="s.descripcion">{{ s.descripcion }}</span>
            </div>
          </ng-template>
        </p-dropdown>
        <div class="actions">
          <button pButton type="button" label="Guardar vigente" icon="pi pi-save" (click)="saveVigente()" [disabled]="!selectedStrategyId || savingVigente"></button>
        </div>
      </div>

      <!-- Vista previa de la vigente -->
      <div class="strategy-preview" *ngIf="selectedStrategy as s">
        <div class="kv"><span>Nombre</span><b>{{ s.nombre }}<ng-container *ngIf="s.descripcion"> - {{ s.descripcion }}</ng-container></b></div>
        <div class="kv" *ngIf="s.descripcion"><span>Descripción</span><b>{{ s.descripcion }}</b></div>
        <div class="flags">
          <div class="flag" *ngFor="let f of [
            {k:'hereda_roles', l:'Hereda Roles'},
            {k:'crea_roles_locales', l:'Crea Roles Locales'},
            {k:'crea_parametros_locales', l:'Crea Parámetros Locales'},
            {k:'autonomia_menu_local', l:'Autonomía Menú Local'},
            {k:'crea_usuarios_en_seccion', l:'Crea Usuarios en Sección'},
            {k:'gestiona_vehiculos_locales', l:'Gestiona Vehículos Locales'},
            {k:'asigna_permisos_directos', l:'Asigna Permisos Directos'}
          ]">
            <i class="pi" [ngClass]="$any(s)[f.k] ? 'pi-check-circle good' : 'pi-times-circle bad'"></i>
            <span class="flag-text">{{ f.l }}</span>
          </div>
        </div>
        <div class="kv"><span>Alcance Ingresos</span><b>{{ s.alcance_ingresos }}</b></div>
      </div>

      <hr class="divider" />

      <!-- Estrategias habilitadas (múltiples) -->
      <div class="field">
        <label for="estrategiasActivas">Estrategias habilitadas (múltiples)</label>
        <p-multiSelect id="estrategiasActivas"
                       [options]="strategies"
                       optionLabel="nombre"
                       optionValue="id"
                       [(ngModel)]="activeIds"
                       defaultLabel="Seleccione estrategias"
                       [filter]="true"
                       filterBy="nombre,descripcion"
                       display="chip">
          <ng-template pTemplate="chip" let-s>
            <span class="chip-item">{{ s?.nombre }}<ng-container *ngIf="s?.descripcion"> - {{ s.descripcion }}</ng-container></span>
          </ng-template>
          <ng-template pTemplate="item" let-s>
            <div class="opt-item">
              <span class="opt-title">{{ s.nombre }}</span>
              <span class="opt-sep" *ngIf="s.descripcion"> - </span>
              <span class="opt-desc" *ngIf="s.descripcion">{{ s.descripcion }}</span>
            </div>
          </ng-template>
        </p-multiSelect>
        <div class="actions">
          <button pButton type="button" label="Guardar habilitadas" icon="pi pi-check-square" class="p-button-secondary" (click)="saveActivas()" [disabled]="savingActivas"></button>
        </div>
        <small class="hint">Las habilitadas pueden convivir como variantes; la vigente (arriba) es la que se aplica por defecto para la organización.</small>
      </div>

    </p-card>
  </div>
</div>
