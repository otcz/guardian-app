<div class="admin-grid">
  <!-- Sidebar izquierda: navegación -->
  <aside class="nav">
    <div class="section-title">Administración</div>
    <a routerLink="/dashboard"><i class="pi pi-home"></i><span>Inicio</span></a>
    <ng-container *ngIf="(menu$ | async) as opts">
      <a *ngFor="let opt of opts" [routerLink]="opt.path">
        <i class="mdi" [ngClass]="opt.icon"></i>
        <span>{{ opt.descripcion }}</span>
      </a>
    </ng-container>
  </aside>

  <!-- Contenido principal: listado -->
  <section class="card">
    <header style="display:flex; align-items:center; justify-content:space-between; margin-bottom:8px;">
      <h2 style="margin:0;">Parámetros</h2>
      <div style="display:flex; gap:8px; align-items:center;">
        <button *ngIf="canCreateParam()" pButton type="button" class="p-button p-button-outlined" (click)="nuevo()"><i class="pi pi-plus"></i><span style="margin-left:8px;">Nuevo</span></button>
        <app-theme-toggle mode="cycle"></app-theme-toggle>
        <app-user-avatar></app-user-avatar>
      </div>
    </header>
    <p class="muted" style="margin:0 0 12px 0;">Gestiona las definiciones de parámetros (Nombre y Descripción).</p>

    <p-table [value]="(lista$ | async) || []" [tableStyle]="{ 'min-width': '680px' }" [paginator]="true" [rows]="10">
      <ng-template pTemplate="header">
        <tr>
          <th style="width: 60px; text-align:center;">#</th>
          <th style="width: 90px;">Org ID</th>
          <th style="width: 280px;">Nombre</th>
          <th>Descripción</th>
          <th style="width: 120px;">Por defecto</th>
          <th style="width: 120px;">Activo</th>
          <th style="width: 120px; text-align:right;">Acciones</th>
        </tr>
      </ng-template>
      <ng-template pTemplate="body" let-row let-i="rowIndex">
        <tr>
          <td style="text-align:center;">{{ i + 1 }}</td>
          <td>{{ row.orgIdDef ?? row.orgId }}</td>
          <td><code>{{ row.nombre }}</code></td>
          <td>{{ row.descripcion }}</td>
          <td>{{ row.porDefecto | yesNo }}</td>
          <td>
            <span pTooltip="{{ getParamToggleReason(row) }}" [tooltipDisabled]="canToggleParam(row)" tooltipPosition="top">
              <p-inputSwitch [ngModel]="(row.activo ?? row.activoValor ?? row.activoDef ?? true)" (onChange)="toggleActivo(row, $event.checked)" [disabled]="!canToggleParam(row)"></p-inputSwitch>
            </span>
          </td>
          <td style="text-align:right; display:flex; justify-content:flex-end; gap:6px;">
            <button *ngIf="canEditParam(row)" pButton type="button" class="p-button p-button-text" (click)="editar(row)" title="Editar"><i class="pi pi-pencil"></i></button>
            <button pButton type="button" class="p-button p-button-text" (click)="configurar(row)" title="Configurar"><i class="pi pi-cog"></i></button>
            <button *ngIf="canDeleteParam(row)" pButton type="button" class="p-button p-button-text danger" (click)="confirmarEliminar(row)" title="Eliminar"><i class="pi pi-trash"></i></button>
          </td>
        </tr>
      </ng-template>
    </p-table>
  </section>
</div>

<!-- Panel lateral derecho: Formulario de edición/creación -->
<p-sidebar [visible]="panelAbierto()" position="right" [modal]="true" (onHide)="cerrarPanel()" styleClass="p-sidebar-sm light-sidebar" [dismissible]="false" [closeOnEscape]="false" [showCloseIcon]="true" [blockScroll]="true" [style]="{ width: '480px' }">
  <div class="sidebar-panel white-theme">
    <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:12px;">
      <h3 style="margin:0;">{{ editandoId() ? 'Editar parámetro' : 'Nuevo parámetro' }}</h3>
      <button pButton type="button" class="p-button p-button-text" (click)="cerrarPanel()"><i class="pi pi-times"></i></button>
    </div>
    <form [formGroup]="form" (ngSubmit)="guardar()" style="display:flex; flex-direction:column; gap:12px;">
      <div class="form-field">
        <label for="nombre">Nombre (MAYÚSCULAS y _)</label>
        <input id="nombre" pInputText appUppercase type="text" formControlName="nombre" placeholder="DURACION_TOKEN_INGRESO" />
      </div>
      <div class="form-field">
        <label for="descripcion">Descripción</label>
        <input id="descripcion" pInputText appUppercase type="text" formControlName="descripcion" placeholder="DESCRIPCIÓN" />
      </div>
      <div class="form-field" style="align-items:flex-start;">
        <label>Activo</label>
        <p-inputSwitch formControlName="activo"></p-inputSwitch>
      </div>

      <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:4px;">
        <button pButton type="button" class="p-button p-button-outlined" (click)="cerrarPanel()">Cancelar</button>
        <button pButton type="submit" class="p-button p-button-primary" [disabled]="form.invalid">{{ editandoId() ? 'Editar' : 'Guardar' }}</button>
      </div>
    </form>
  </div>
</p-sidebar>

<!-- Diálogo de confirmación global -->
<p-confirmDialog></p-confirmDialog>
