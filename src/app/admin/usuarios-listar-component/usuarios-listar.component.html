<div class="container">
  <p-card class="card">
    <div class="page-header">
      <h2>Usuarios</h2>
      <span class="spacer"></span>
      <button pButton type="button" label="Crear usuario" icon="pi pi-plus" [routerLink]="['/gestion-de-usuarios/crear-usuario']"></button>
    </div>

    <div class="field">
      <input pInputText type="text" placeholder="Buscar por username, nombre, email o alcance..." [(ngModel)]="filter" (ngModelChange)="applyFilter()" />
    </div>

    <p-table [value]="filtered" [loading]="loading" [rows]="10" [paginator]="true" [responsiveLayout]="'scroll'">
      <ng-template pTemplate="header">
        <tr>
          <th>Usuario</th>
          <th>Alcance/Sección</th>
          <th>Estado</th>
          <th style="width:360px;">Acciones</th>
        </tr>
      </ng-template>
      <ng-template pTemplate="body" let-u>
        <tr>
          <td>
            <div class="user-cell">
              <p-avatar [label]="userInitial(u)" shape="circle" size="large" [style]="{ background: 'linear-gradient(135deg, var(--primary), var(--secondary))', color: '#fff' }"></p-avatar>
              <div class="meta">
                <div class="top">{{ u.username }}</div>
                <div class="sub">{{ u.nombreCompleto || u.email || '—' }}</div>
              </div>
            </div>
          </td>
          <td>
            <div class="stack">
              <p-chip icon="pi pi-shield" [label]="u.scopeNivel || '-'" class="pill muted"></p-chip>
              <p-chip *ngIf="u.seccionPrincipalId" icon="pi pi-sitemap" [label]="'Sección: ' + sectionName(u)" class="pill"></p-chip>
            </div>
          </td>
          <td>
            <p-tag [value]="u.activo ? 'ACTIVO' : 'INACTIVO'" [severity]="u.activo ? 'success' : 'danger'"></p-tag>
          </td>
          <td>
            <div class="actions">
              <button pButton type="button" icon="pi pi-cog" label="Gestionar" class="p-button p-button-text" [routerLink]="['/gestion-de-usuarios/gestionar-usuario']" [queryParams]="{ id: u.id }" pTooltip="Gestionar usuario" tooltipPosition="top"></button>
              <button pButton type="button" [label]="u.activo ? 'Desactivar' : 'Activar'" [icon]="u.activo ? 'pi pi-ban' : 'pi pi-check'" [class]="u.activo ? 'p-button p-button-outlined p-button-danger' : 'p-button p-button-outlined p-button-success'" (click)="toggle(u)" pTooltip="Cambiar estado" tooltipPosition="top"></button>
              <button pButton type="button" icon="pi pi-user-plus" label="Asignar roles" class="p-button p-button-text" [routerLink]="['/gestion-de-usuarios/asignar-roles']" [queryParams]="{ id: u.id }"></button>
              <button pButton type="button" icon="pi pi-sitemap" label="Asignar sección" class="p-button p-button-text" [routerLink]="['/gestion-de-usuarios/asignar-usuario-a-seccion']" [queryParams]="{ id: u.id }"></button>
            </div>
          </td>
        </tr>
      </ng-template>
    </p-table>
  </p-card>
</div>
