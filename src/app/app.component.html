<ng-container *ngIf="isAuthScreen; else mainLayout">
  <router-outlet></router-outlet>
</ng-container>

<ng-template #mainLayout>
  <div style="display:flex; height:100vh;">
    <aside class="sidebar" [style.width.px]="sidebarOpen ? 260 : 60" style="transition:width .2s; padding:12px; background:#1e293b; color:#fff; overflow:auto;">
      <button pButton type="button" class="p-button p-button-text" (click)="sidebarOpen = !sidebarOpen" aria-label="Colapsar sidebar">
        <i class="pi" [ngClass]="sidebarOpen ? 'pi-angle-left' : 'pi-angle-right'"></i>
      </button>

      <div *ngIf="sidebarOpen" style="margin-top:12px; display:flex; flex-direction:column; gap:14px;">
        <div style="display:flex; gap:6px; align-items:center;">
          <input pInputText type="text" placeholder="Buscar..." [(ngModel)]="searchQuery" (ngModelChange)="onSearchChange($event)" style="flex:1; padding:4px 8px; font-size:.8rem;"/>
          <button pButton type="button" class="p-button p-button-text" (click)="expandAll()" title="Expandir todo"><i class="pi pi-plus"></i></button>
          <button pButton type="button" class="p-button p-button-text" (click)="collapseAll()" title="Colapsar todo"><i class="pi pi-minus"></i></button>
        </div>
        <a routerLink="/" class="menu-link" style="color:#fff; display:flex; align-items:center; gap:10px; font-weight:600; text-decoration:none;">
          <i class="pi pi-home"></i>
          <span>Inicio</span>
        </a>

        <ng-container *ngIf="(filteredMenus$ | async) as menus">
          <div *ngFor="let menu of menus" class="menu-group" style="display:flex; flex-direction:column; gap:4px;">
            <div class="menu-header" (click)="toggleMenu(menu.key)">
              <i class="pi" [ngClass]="isExpanded(menu.key) ? 'pi-chevron-down' : 'pi-chevron-right'"></i>
              <i [ngClass]="menu.icon || 'pi pi-circle'"></i>
              <span class="menu-title">{{ menu.label }}</span>
              <span *ngIf="menu.children?.length" class="menu-badge">{{ menu.children?.length }}</span>
            </div>
            <div class="menu-items" *ngIf="isExpanded(menu.key)">
              <a *ngFor="let child of menu.children" [routerLink]="(child.path || '').split('?')[0]" [queryParams]="parseQuery(child.path)" class="menu-item">
                <i [ngClass]="child.icon || 'pi pi-circle'"></i>
                <span>{{ child.label }}</span>
              </a>
            </div>
            <div class="menu-divider"></div>
          </div>
          <div *ngIf="menus.length === 0" style="font-size:.7rem; opacity:.6; padding:8px 4px;">Sin resultados</div>
        </ng-container>
      </div>
    </aside>

    <div style="display:flex; flex-direction:column; flex:1; min-width:0;">
      <header class="header">
        <img src="assets/logo.png" alt="Logo" style="height:28px;" />
        <div class="spacer"></div>
        <button pButton type="button" class="p-button p-button-text" aria-label="Notificaciones"><i class="pi pi-bell"></i></button>
        <app-user-avatar-pro></app-user-avatar-pro>
      </header>
      <main class="main" style="padding:16px;">
        <router-outlet></router-outlet>
      </main>
    </div>
  </div>

  <div class="theme-fab">
    <app-theme-toggle mode="cycle"></app-theme-toggle>
  </div>

  <app-feedback-center></app-feedback-center>
</ng-template>
