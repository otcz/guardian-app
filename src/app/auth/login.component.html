<div class="container login-page">
  <div class="login-card card">
    <div class="login-card__header">
      <img src="assets/logo.png" alt="Logo" class="login-card__logo" />
      <app-theme-toggle mode="cycle"></app-theme-toggle>
    </div>

    <div class="login-card__body">
      <h2 class="login-title">Iniciar sesión</h2>
      <p class="login-subtitle">Accede con tus credenciales.</p>

      <form [formGroup]="form" (ngSubmit)="submit()" class="login-form">
        <div class="field field-with-chip">
          <input class="login-input" pInputText appUppercase type="text" formControlName="username" placeholder="Usuario" autocomplete="username" autocapitalize="none" autocorrect="off" spellcheck="false" data-no-uppercase />
          <span *ngIf="isSysadmin" class="system-chip">SYSTEM</span>
        </div>
        <div class="field field-with-action">
          <input class="login-input" pInputText [type]="showPassword ? 'text' : 'password'" formControlName="password" placeholder="Contraseña" autocomplete="current-password" autocapitalize="none" autocorrect="off" spellcheck="false" data-no-uppercase />
          <button type="button" pButton class="p-button p-button-text field-action" (click)="togglePassword()">
            <i class="pi" [ngClass]="showPassword ? 'pi-eye-slash' : 'pi-eye'"></i>
          </button>
        </div>

        <div class="forgot-row">
          <a href="#">¿Olvidaste tu contraseña?</a>
        </div>

        <button pButton type="submit" class="p-button p-button-primary" [disabled]="form.invalid || loading">
          <span *ngIf="!loading">Entrar</span>
          <span *ngIf="loading"><i class="pi pi-spin pi-spinner"></i></span>
        </button>

        <div class="divider-with-text">
          <span class="divider"></span>
          <span class="divider-text">o</span>
          <span class="divider"></span>
        </div>
        <a routerLink="/register" class="p-button p-button-outlined register-btn">
          <i class="pi pi-user-plus"></i>
          <span>Registrarse</span>
        </a>

        <div *ngIf="errorMsg" class="snackbar snackbar-error error-banner">{{ errorMsg }}</div>
      </form>
    </div>
  </div>
</div>

<!-- Diálogo: Crear contraseña inicial -->
<p-dialog [(visible)]="showPwdSetup" [modal]="true" [draggable]="false" [resizable]="false" [closable]="true" (onHide)="cancelFirstPassword()" header="Crear contraseña inicial">
  <div class="pwd-setup">
    <p class="pwd-setup__lead">Este es un paso único para establecer tu contraseña. Usuario: <strong>{{ setupUsername }}</strong></p>

    <form [formGroup]="firstPwdForm" (ngSubmit)="submitFirstPassword()" class="pwd-setup__form">
      <div class="field field-with-action">
        <input class="login-input" pInputText [type]="showNewPwd ? 'text' : 'password'" formControlName="newPassword" placeholder="Nueva contraseña" autocomplete="new-password" autocapitalize="none" autocorrect="off" spellcheck="false" data-no-uppercase />
        <button type="button" pButton class="p-button p-button-text field-action" (click)="toggleNewPwd()">
          <i class="pi" [ngClass]="showNewPwd ? 'pi-eye-slash' : 'pi-eye'"></i>
        </button>
      </div>

      <div class="policy-box" aria-live="polite">
        <div class="policy-box__title">Requisitos de contraseña</div>
        <ul class="policy-list">
          <li [class.met]="policyStatus.len">
            <i class="pi" [ngClass]="policyStatus.len ? 'pi-check-circle' : 'pi-times-circle'"></i>
            Mínimo 8 caracteres
          </li>
          <li [class.met]="policyStatus.upper">
            <i class="pi" [ngClass]="policyStatus.upper ? 'pi-check-circle' : 'pi-times-circle'"></i>
            Al menos 1 letra mayúscula (A-Z)
          </li>
          <li [class.met]="policyStatus.lower">
            <i class="pi" [ngClass]="policyStatus.lower ? 'pi-check-circle' : 'pi-times-circle'"></i>
            Al menos 1 letra minúscula (a-z)
          </li>
          <li [class.met]="policyStatus.digit">
            <i class="pi" [ngClass]="policyStatus.digit ? 'pi-check-circle' : 'pi-times-circle'"></i>
            Al menos 1 dígito (0-9)
          </li>
          <li [class.met]="policyStatus.symbol">
            <i class="pi" [ngClass]="policyStatus.symbol ? 'pi-check-circle' : 'pi-times-circle'"></i>
            Al menos 1 símbolo: <span ngNonBindable class="symbols">! &#64; # $ % ^ &amp; * ( ) _ + - = [ ] &#123; &#125; ; : &#39; &quot; &#92; | , . &lt; &gt; / ? &#96; ~</span>
          </li>
          <li [class.met]="policyStatus.nospace">
            <i class="pi" [ngClass]="policyStatus.nospace ? 'pi-check-circle' : 'pi-times-circle'"></i>
            Sin espacios en blanco
          </li>
        </ul>
      </div>

      <div class="field field-with-action">
        <input class="login-input" pInputText [type]="showConfirmPwd ? 'text' : 'password'" formControlName="confirmPassword" placeholder="Confirmar contraseña" autocomplete="new-password" autocapitalize="none" autocorrect="off" spellcheck="false" data-no-uppercase />
        <button type="button" pButton class="p-button p-button-text field-action" (click)="toggleConfirmPwd()">
          <i class="pi" [ngClass]="showConfirmPwd ? 'pi-eye-slash' : 'pi-eye'"></i>
        </button>
      </div>

      <div *ngIf="firstPwdForm.errors?.['mismatch'] && (firstPwdForm.dirty || firstPwdForm.touched)" class="field-error">
        Las contraseñas no coinciden.
      </div>
      <div *ngIf="firstPwdForm.get('newPassword')?.errors?.['minlength']" class="field-error">
        La contraseña debe tener al menos 8 caracteres.
      </div>
      <div *ngIf="firstPwdMsg" class="snackbar snackbar-error error-banner">{{ firstPwdMsg }}</div>

      <div class="actions-row">
        <button pButton type="button" class="p-button p-button-text" (click)="cancelFirstPassword()">Cancelar</button>
        <button pButton type="submit" class="p-button p-button-success" [disabled]="firstPwdForm.invalid || loading">
          <span *ngIf="!loading">Guardar</span>
          <span *ngIf="loading"><i class="pi pi-spin pi-spinner"></i></span>
        </button>
      </div>
    </form>
  </div>
</p-dialog>
