<nav class="sidebar-root" role="navigation" aria-label="Main menu">
  <!-- Desktop: Sidebar fijo -->
  <div class="sidebar-fixed" [class.collapsed]="collapsed" *ngIf="!mobileVisible">
    <div class="sidebar-header">
      <button class="sidebar-toggle" (click)="toggleSidebar()" [attr.aria-label]="collapsed ? 'Expandir menú' : 'Colapsar menú'">
        <i class="pi" [ngClass]="collapsed ? 'pi-angle-right' : 'pi-angle-left'"></i>
      </button>
    </div>
    <ul class="sidebar-list">
      <ng-container *ngFor="let item of menuItems; let i = index">
        <li class="sidebar-item" [class.has-submenu]="item.items" [attr.aria-expanded]="item.expanded" [attr.aria-label]="item.label">
          <!-- Item sin submenú -->
          <a *ngIf="!item.items" [routerLink]="item.routerLink" pTooltip="{{collapsed ? item.label : ''}}" tooltipPosition="right" tabindex="0"
             [attr.aria-label]="item.label" [attr.role]="'menuitem'">
            <span class="sidebar-icon"><i class="pi" [ngClass]="item.icon"></i></span>
            <span class="sidebar-label" [style.opacity]="collapsed ? 0 : 1" [style.transform]="collapsed ? 'translateX(-8px)' : 'none'">{{ item.label }}</span>
          </a>
          <!-- Item con submenú (primer nivel) -->
          <div *ngIf="item.items" class="sidebar-submenu-trigger"
               (click)="collapsed ? showPopover($event, item.items) : item.expanded = !item.expanded"
               (keydown)="onKeydown($event, item)"
               pTooltip="{{collapsed ? item.label : ''}}" tooltipPosition="right" tabindex="0"
               [attr.aria-expanded]="item.expanded" [attr.aria-controls]="'submenu-' + i" [attr.role]="'menuitem'">
            <span class="sidebar-icon"><i class="pi" [ngClass]="item.icon"></i></span>
            <span class="sidebar-label" [style.opacity]="collapsed ? 0 : 1" [style.transform]="collapsed ? 'translateX(-8px)' : 'none'">{{ item.label }}</span>
            <i class="pi pi-chevron-right submenu-arrow" [class.rotated]="item.expanded" *ngIf="!collapsed"></i>
          </div>
          <!-- Submenú expandido (primer nivel) -->
          <ul class="sidebar-submenu" *ngIf="item.items && item.expanded && !collapsed" [attr.id]="'submenu-' + i">
            <ng-container *ngFor="let sub of item.items; let j = index">
              <li>
                <!-- Subitem sin submenú (segundo nivel) -->
                <a *ngIf="!sub.items" [routerLink]="sub.routerLink" tabindex="0" [attr.role]="'menuitem'">
                  <span class="sidebar-icon"><i class="pi" [ngClass]="sub.icon"></i></span>
                  <span class="sidebar-label">{{ sub.label }}</span>
                </a>
                <!-- Subitem con submenú (segundo nivel) -->
                <div *ngIf="sub.items" class="sidebar-submenu-trigger"
                     (click)="sub.expanded = !sub.expanded"
                     tabindex="0"
                     [attr.aria-expanded]="sub.expanded" [attr.aria-controls]="'submenu2-' + i + '-' + j" [attr.role]="'menuitem'">
                  <span class="sidebar-icon"><i class="pi" [ngClass]="sub.icon"></i></span>
                  <span class="sidebar-label">{{ sub.label }}</span>
                  <i class="pi pi-chevron-right submenu-arrow" [class.rotated]="sub.expanded"></i>
                </div>
                <!-- Submenú anidado (segundo nivel) -->
                <ul class="sidebar-submenu" *ngIf="sub.items && sub.expanded" [attr.id]="'submenu2-' + i + '-' + j">
                  <li *ngFor="let sub2 of sub.items">
                    <a [routerLink]="sub2.routerLink" tabindex="0" [attr.role]="'menuitem'">
                      <span class="sidebar-icon"><i class="pi" [ngClass]="sub2.icon"></i></span>
                      <span class="sidebar-label">{{ sub2.label }}</span>
                    </a>
                  </li>
                </ul>
              </li>
            </ng-container>
          </ul>
        </li>
      </ng-container>
    </ul>
    <!-- Popover para submenús en colapsado -->
    <p-overlayPanel #overlayPanel [showCloseIcon]="true" [dismissable]="true" [style]="{minWidth: '180px', background: 'var(--sidebar-popover-bg)'}">
      <ul class="sidebar-popover-list">
        <li *ngFor="let sub of popoverItems">
          <a [routerLink]="sub.routerLink" tabindex="0" [attr.role]="'menuitem'">
            <span class="sidebar-icon"><i class="pi" [ngClass]="sub.icon"></i></span>
            <span class="sidebar-label">{{ sub.label }}</span>
          </a>
        </li>
      </ul>
    </p-overlayPanel>
  </div>

  <!-- Móvil: Drawer -->
  <p-sidebar [(visible)]="mobileVisible" position="left" [modal]="true" [dismissible]="true" [baseZIndex]="3000" (onHide)="closeMobileSidebar()" [style]="{width: '80vw', maxWidth: '320px'}" [attr.role]="'dialog'" [attr.aria-modal]="'true'">
    <div class="sidebar-header">
      <button class="sidebar-toggle" (click)="closeMobileSidebar()" aria-label="Cerrar menú">
        <i class="pi pi-times"></i>
      </button>
    </div>
    <p-panelMenu [model]="menuItems"></p-panelMenu>
  </p-sidebar>
</nav>
