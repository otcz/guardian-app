<p-popover #pop [dismissable]="true" [showCloseIcon]="true" styleClass="user-popover">
  <div class="panel">
    <div class="hero">
      <div class="ring"><div class="inner">{{ initials() }}</div></div>
      <div class="hero-meta">
        <div class="title">{{ displayName() }}</div>
        <div class="hint">{{ emailHint() }}</div>
        <div class="roles-row" *ngIf="primaryRole()">
          <span class="label" style="opacity:.8; margin-right:6px; font-size:.85rem;">Rol:</span>
          <p-tag [value]="primaryRole()" severity="info"></p-tag>
          <small *ngIf="(roles() || []).length > 1" style="margin-left:6px; opacity:.7;">(+{{ (roles() || []).length - 1 }})</small>
        </div>
      </div>
    </div>
    <div class="body">
      <div class="session">
        <i class="bar"><span class="bar-fill" [style.width.%]="progressPercent()"></span></i>
        <div class="time">{{ sessionLeftDetailed() }}</div>
      </div>

      <div style="display:flex; gap:.4rem; flex-wrap:wrap; margin:.4rem 0 .6rem;">
        <p-tag [value]="'Org: ' + (orgName() || '—')" severity="contrast"></p-tag>
        <p-tag *ngIf="seccionName()" [value]="'Sección: ' + seccionName()" severity="secondary"></p-tag>
        <p-tag *ngIf="scopeNivel()" [value]="'Alcance: ' + scopeNivel()" severity="info"></p-tag>
      </div>

      <div class="orgs" *ngIf="displayedOrgs().length">
        <div class="org-item" *ngFor="let o of displayedOrgs()" [class.active]="o.id === orgId()" (click)="switchOrg(o, pop)">
          <span class="dot"></span>
          <div class="meta-col">
            <b>{{ o.nombre }}</b>
            <small class="status">{{ o.activa ? 'Activa' : 'Inactiva' }}</small>
          </div>
        </div>
      </div>

      <div class="actions">
        <button pButton type="button" class="p-button-text" icon="pi pi-cog" label="Gestionar" (click)="goManage(pop)"></button>
        <button pButton type="button" class="p-button-text" icon="pi pi-list" label="Organizaciones" (click)="goList(pop)"></button>
        <button pButton type="button" class="p-button-danger p-button-text" icon="pi pi-sign-out" label="Salir" (click)="logout()"></button>
      </div>
    </div>
  </div>
</p-popover>

<div class="chip" (click)="pop.toggle($event)">
  <div class="initials">{{ initials() }}</div>
  <div class="meta">
    <div class="org">{{ orgShort() }}</div>
    <div class="name">{{ shortName() }}</div>
  </div>
</div>
